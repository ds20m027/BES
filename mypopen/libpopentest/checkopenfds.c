/**
 * @file checkopenfds.c
 * Betriebsysteme simple program that exits with EXIT_FAILURE if file descriptors other
 * than stdin, stdout, and stderr are open
 * Beispiel 1.2
 *
 * @author Thomas M. Galla <galla@technikum-wien.at>
 * @date 2013/02/24
 *
 * @version $Revision$
 *
 * @todo Nothing to do. - Everything perfect! ;-)
 *
 * URL: $HeadURL$
 *
 * Last Modified: $Author$
 */

/*
 * -------------------------------------------------------------- includes --
 */

#include <stdio.h>
#include <stdlib.h>
#include <limits.h>
#include <unistd.h>
#include <getopt.h>

#include "utils.h"

/*
 * --------------------------------------------------------------- defines --
 */

/*
 * -------------------------------------------------------------- typedefs --
 */

/*
 * --------------------------------------------------------------- globals --
 */

const char *cmd;

/*
 * ------------------------------------------------------------- functions --
 */

void freeresources(
    void
    )
{
}		   

static void usage(
    void
    )
{
    (void) fprintf(stderr, "USAGE: %s [-v] [-t <fd>]\n", cmd);
    exit(EXIT_FAILURE);
}

int main(
    int argc,
    char *argv[]
    )
{
    int c;
    long fd = -1;
    char *endptr = NULL;

    cmd = argv[0];

    while ((c = getopt(argc, argv, "vt:")) != EOF)
    {
        switch(c)
        {
        case 'v':
            setVerbose(getVerbose() + 1);
            break;

        case 't':
	    errno = 0;
            fd = strtol(optarg, &endptr, 10);

	    if (
		((errno == ERANGE) && ((fd == LONG_MAX) || (fd == LONG_MIN))) ||
		((errno != 0) && (fd == 0)) ||
		(endptr == optarg) ||
		(*endptr != '\0') ||
		(fd < 0) ||
		(fd >= FD_SETSIZE) 
		)
	    {
		usage();
	    }

            break;

        default:
            usage();
            break;
        }
    }

    size_t num_fds_open = argc - optind;

    int fds_open[num_fds_open];

    /* set dedicated trace stream */
    if (fd != -1)
    {
	FILE *trace_stream;
	
        if ((trace_stream = fdopen(fd, "w")) == NULL)
	{
	    bailout("Cannot open trace stream");
	}

	setTraceStream(trace_stream);

	ENTER();

	TRACE2("Trace stream is set to file descriptor %ld ...\n", fd);
    }
    else
    {
	ENTER();
    }

    for (size_t i = 0; i < num_fds_open; ++i)
    {
	errno = 0;
	fd = strtol(argv[optind + i], &endptr, 10);

	if (
	    ((errno == ERANGE) && ((fd == LONG_MAX) || (fd == LONG_MIN))) ||
	    ((errno != 0) && (fd == 0)) ||
	    (endptr == optarg) ||
	    (*endptr != '\0') ||
	    (fd < 0) ||
	    (fd >= FD_SETSIZE) 
	    )
	{
	    usage();
	}

	TRACE2("Adding file descriptor %ld to the list of opened file descriptors ...\n", fd);

	fds_open[i] = fd;
    }

    if (!verify_open_file_desc(fds_open, num_fds_open))
    {

        EXIT();
	return EXIT_FAILURE;
    }

    if (!verify_closed_file_desc(fds_open, num_fds_open))
    {

        EXIT();
	return EXIT_FAILURE;
    }

    EXIT();
    return EXIT_SUCCESS;
}

/*
 * =================================================================== eof ==
 */

/*
 * Local Variables:
 * c-basic-offset: 4
 * End:
 */
