/**
 * @file killparent.c
 * Betriebsysteme simple program kills its parent
 * Beispiel 1.2
 *
 * @author Thomas M. Galla <galla@technikum-wien.at>
 * @date 2011/12/17
 *
 * @version $Revision: 811 $
 *
 * @todo Nothing to do. - Everything perfect! ;-)
 *
 * URL: $HeadURL: https://svn.petrovitsch.priv.at/ICSS-BES/trunk/2014/src/mypopen/killparent.c $
 *
 * Last Modified: $Author: tom $
 */

/*
 * -------------------------------------------------------------- includes --
 */

#include <stdio.h>
#include <stdlib.h>
#include <limits.h>
#include <string.h>
#include <errno.h>
#include <sys/types.h>
#include <unistd.h>
#include <signal.h>

#include "utils.h"

/*
 * --------------------------------------------------------------- defines --
 */

/*
 * -------------------------------------------------------------- typedefs --
 */

/*
 * --------------------------------------------------------------- globals --
 */

/*
 * ------------------------------------------------------------- functions --
 */

void freeresources(
    void
    )
{
}		   

static void usage(
    void
    )
{
    (void) fprintf(stderr, "USAGE: %s [-v] <dont_kill_this_pid>\n", program_invocation_name);
    exit(EXIT_FAILURE);
}

int main(
    int argc,
    char *argv[]
    )
{
    const pid_t parents_pid = getppid();
    int c;
    while ((c = getopt(argc, argv, "v")) != EOF)
    {
        switch(c)
        {
        case 'v':
            setVerbose(getVerbose()+1);
            break;

        default:
            usage();
            break;
        }
    }

    ENTER();

    /* wrong number of arguments? */
    if (argc != optind + 1)
    {
        usage(); /* show usage to user */
    }

    char *eptr;
    const long dont_kill_this_pid = strtol(argv[optind], &eptr, 10);

    if (
	(*eptr != '\0') ||
	(eptr == argv[optind]) ||
	((dont_kill_this_pid == LONG_MAX) && (errno == ERANGE)) ||
	(dont_kill_this_pid <= 0)
	)
    {
	usage();
    }

    TRACE("Process with PID %ld must not be killed ...\n", dont_kill_this_pid); 
    
    /*
     * kill the parent unless we are not allowed to do so
     * => this causes abnormal termination of parent
     */
    if (dont_kill_this_pid != parents_pid)
    {
      TRACE("Killing parent with PID %d ...\n", parents_pid); 

	if (kill(parents_pid, SIGTERM) == -1)
	{
	    (void) fprintf(
		stderr,
		"%s: Cannot kill parent with PID %d - %s.\n",
		argv[0],
                parents_pid,
		strerror(errno)
		);
	}
    }

    TRACE("Calling abort to enforce abnormal termination of this process ...\n"); 

    EXIT();

    /*
     * abort own process to enforce abnormal termination of this
     * process
     */
    abort();

    return EXIT_SUCCESS; /* never reached */
}

/*
 * =================================================================== eof ==
 */
